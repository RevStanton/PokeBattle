<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dexteria — Pokédex</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header>
    <h1>Dexteria</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="battle.html">Battle</a>
      <a href="pokedex.html" class="active">Pokédex</a>
    </nav>
  </header>

  <main class="main-content info-page all-pokemon-page">
    <!-- 1) Filter box -->
    <div class="search-panel">
      <input
        id="pokemon-search-all"
        type="text"
        placeholder="Filter Pokémon…"
        autocomplete="off"
      />
    </div>

    <!-- 2) Grid of all Pokémon -->
    <div id="all-pokemon-container" class="pokemon-grid"></div>
  </main>

  <!-- 3) Modal for full details -->
  <div id="pokemon-modal" class="modal hidden">
    <div class="modal-content">
      <button id="modal-close" class="modal-close">✕</button>
      <!-- Your infoRenderer will fill this -->
      <div id="pokemon-details"></div>
    </div>
  </div>

  <script type="module">
    import { fetchAllPokemonList }  
      from './services/allPokemonService.js';
    import {
      fetchPokemonData,
      fetchPokemonSpecies,
      fetchAbilityInfo,
      fetchEvolutionChain
    }                                 from './services/api.js';
    import { renderPokemonList }      
      from './ui/allPokemonRenderer.js';
    import { renderPokemonInfo }      
      from './ui/infoRenderer.js';

    async function init() {
      // 1) load & show the grid
      let allList = [];
      try {
        allList = await fetchAllPokemonList();
        renderPokemonList(allList);
      } catch (err) {
        console.error('❌ Failed to load list:', err);
      }

      // 2) live‑filter
      document
        .getElementById('pokemon-search-all')
        .addEventListener('input', e => {
          const q = e.target.value.trim().toLowerCase();
          renderPokemonList(
            allList.filter(p => p.name.includes(q))
          );
        });

      // 3) click a card → open modal
      const grid     = document.getElementById('all-pokemon-container');
      const modal    = document.getElementById('pokemon-modal');
      const details  = document.getElementById('pokemon-details');
      const closeBtn = document.getElementById('modal-close');

      grid.addEventListener('click', async e => {
        const card = e.target.closest('.pkmn-card');
        if (!card) return;
        const name = card.dataset.name;

        // show loading state
        details.innerHTML = '<p>Loading…</p>';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        try {
          // fetch core + species
          const baseData    = await fetchPokemonData(name);
          const speciesData = await fetchPokemonSpecies(name);

          // fetch abilities
          const abilityDetails = await Promise.all(
            baseData.abilities.map(ab => fetchAbilityInfo(ab))
          );

          // fetch & assemble evolution chain
          const evoNames = await fetchEvolutionChain(name);
          const evolution = await Promise.all(
            evoNames.map(n => fetchPokemonData(n))
          );

          // render everything
          renderPokemonInfo({
            ...baseData,
            ...speciesData,
            abilityDetails,
            evolution
          });

          // wire up clicks on the evo‑chain sprites
          const evoList = details.querySelector('.evo-list');
          if (evoList) {
            evoList.addEventListener('click', async evt => {
              const a = evt.target.closest('a[data-name]');
              if (!a) return;
              evt.preventDefault();
              const nextName = a.dataset.name;

              // repeat the same load/render flow
              details.innerHTML = '<p>Loading…</p>';
              try {
                const bd = await fetchPokemonData(nextName);
                const sd = await fetchPokemonSpecies(nextName);
                const ab = await Promise.all(
                  bd.abilities.map(x => fetchAbilityInfo(x))
                );
                const en = await fetchEvolutionChain(nextName);
                const evo = await Promise.all(
                  en.map(nm => fetchPokemonData(nm))
                );
                renderPokemonInfo({
                  ...bd,
                  ...sd,
                  abilityDetails: ab,
                  evolution: evo
                });
              } catch (err) {
                console.error('❌ Evo chain load failed:', err);
                details.innerHTML = '<p>Error loading evolution.</p>';
              }
            }, { once: true });
          }
        } catch (err) {
          console.error(`❌ Error loading ${name}:`, err);
          details.innerHTML = '<p>Error loading details.</p>';
        }
      });

      // 4) close modal handlers
      closeBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      });
      modal.addEventListener('click', evt => {
        if (evt.target === modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
